// FluidVids
window.Fluidvids = (function (window, document, undefined) {

  'use strict';

  var players, obj;
  var head = document.head || document.getElementsByTagName('head')[0];
  var css = '.fluidvids-elem{position:absolute;top:0px;left:0px;max-width:800px;max-height:501px;width:100%;' +
  'height:100%;}.fluidvids{max-width:800px;max-height:501px;width:100%;position:relative;}';

  var _matchesPlayer = function (source) {
    players = new RegExp('^(https?:)?\/\/(?:' + obj.join('|') + ').*$', 'i');
    return players.test(source);
  };

  var debounce = function (func, wait, immediate) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(function() {
        timeout = null;
        if (!immediate) func.apply(context, args);
      }, wait);
      if (immediate && !timeout) func.apply(context, args);
    };
  };

  var _render = function (elem) {
    var wrap = document.createElement('div');
    var thisParent = elem.parentNode;
    var h = parseInt(elem.height ? elem.height : elem.offsetHeight, 10);
    var w = parseInt(elem.width ? elem.width : elem.offsetWidth, 10);
    var ratio = ((h / w) * 100);

    thisParent.insertBefore(wrap, elem);
    elem.className += ' fluidvids-elem';
    wrap.className += ' fluidvids';
    wrap.style.paddingTop = ratio + '%';

    var thisHeight = parseInt(wrap.height ? wrap.height : wrap.offsetHeight);

    if (thisHeight >= 501)
      wrap.style.paddingTop = '501px';

    wrap.appendChild(elem);
  };

  var resizeWindow = debounce(function () {
    var els = document.querySelectorAll('.fluidvids');

    for (var i = 0; i < els.length; i++) {
      var frame = els[i].querySelectorAll('iframe')[0];
      var h = parseInt(frame.height ? frame.height : frame.offsetHeight, 10);
      var w = parseInt(frame.width ? frame.width : frame.offsetWidth, 10);
      var ratio = ((h / w) * 100);
      els[i].style.paddingTop = ratio + '%';

      var thisHeight = parseInt(els[i].height ? els[i].height : els[i].offsetHeight);

      if (thisHeight >= 501)
        els[i].style.paddingTop = '501px'; 
    }
  }, 250);

  window.addEventListener('resize', resizeWindow);

  var _appendStyles = function () {
    var div = document.createElement('div');
    div.innerHTML = '<p>x</p><style>' + css + '</style>';
    head.appendChild(div.childNodes[1]);
  };

  var init = function (object) {
    var options = object || {};
    var selector = options.selector || 'iframe';
    obj = options.players || ['www.youtube.com', 'player.vimeo.com'];
    var nodes = document.querySelectorAll(selector);
    for (var i = 0; i < nodes.length; i++) {
      var self = nodes[i];
      if (_matchesPlayer(self.src)) {
        _render(self);
      }
    }
    _appendStyles();
  };

  return {
    init: init
  };

})(window, document);

(function (window, document, undefined) {

  var amazonLink = '';//https://s3.amazonaws.com/mixture-mixed/1/11173';

  /** Page setup */
  var body = document.getElementsByTagName('body')[0];
  var headerNav = document.getElementById('js-menu-nav');
  var socialNav = document.getElementById('js-social-nav');

  body.innerHTML += '<div id="page-loader" style="display: none;"></div>';

  /** Global variables */
  var html = document.getElementsByTagName('html')[0];
  var deviceMenuOverlay = document.getElementById('js-overlay');
  var pageLoader = document.getElementById('page-loader');
  var contentBlock = document.getElementById('js-content-block');
  var pageHeader = document.getElementById('js-page-head');
  var projectNav = document.getElementById('js-project-nav');
  var footerNav = document.getElementById('js-footer-nav');
  var deviceMenuBtn = document.getElementById('js-menu');
  headerNav = document.getElementById('js-menu-nav');
  socialNav = document.getElementById('js-social-nav');
  var pushStatePopped = false;
  var portfolioFooterLoaded = false;
  var initialURL = location.href;
  var whiteMenu = hasClass(pageHeader, 'white');
  var homepageData = [];
  var progressTimer;
  var homeTimer;
  var current = 0;

  if (!hasClass(html, 'svg')) {
    var noscript = document.getElementsByTagName('noscript')[0];
    var styleTag = noscript.childNodes[0].data;
    //console.log(styleTag);
    document.head.innerHTML += styleTag;
  }

  var device = function () {
    if (window.addEventListener)
      return 'ontouchstart' in window ? 'touchstart' : 'click';
    else 
      return 'click';
  };

  var scrolled = function () {
    return 'onscroll' in window ? 'onscroll' : 'scroll';
  };

  var desktop = function () {
    return 'click';
  };

  /** Device Menu */
  var toggleDeviceMenu = function (e) {
    deviceMenuOverlay.setAttribute('data-state', deviceMenuOverlay.getAttribute('data-state') === 'visible' ? 'hidden' : 'visible');
    this.setAttribute('data-state', this.getAttribute('data-state') === 'open' ? 'closed' : 'open');
    if (this.getAttribute('data-state') === 'open' && whiteMenu) { removeClass(pageHeader,'white');removeClass(projectNav,'white'); }
    else { if (whiteMenu) { addClass(pageHeader,'white');addClass(projectNav,'white'); } }
    if (this.getAttribute('data-state') === 'open') {
      clearInterval(homeTimer);
    } else {
      if (window.location.pathname === '/')
        homePlay();
    }
    e.preventDefault();
  };

  //deviceMenuBtn.addEventListener(device(), toggleDeviceMenu, false);
  attach(deviceMenuBtn, device(), toggleDeviceMenu);

  /** Navigation */
  var navigationClick = function (e) {
    var href = this.getAttribute('href');
    contentBlock.innerHTML = '';

    if (deviceMenuOverlay) {
      deviceMenuOverlay.setAttribute('data-state', 'hidden');
      deviceMenuBtn.setAttribute('data-state', 'hidden');
    }

    pushHistory(href);
    routing(href);
    e.preventDefault();
  };

  var overlayNavItems = deviceMenuOverlay.querySelectorAll('.menu-nav li a');
  
  for (var i = 0; i < overlayNavItems.length; i++) {
    //overlayNavItems[i].addEventListener(device(), navigationClick, false);
    attach(overlayNavItems[i], device(), navigationClick);
  }

  var headerNavItems = headerNav.querySelectorAll('li a');
  var footerNavItems = footerNav.querySelectorAll('li a');

  for (var i = 0; i < headerNavItems.length; i++){
    //headerNavItems[i].addEventListener(device(), navigationClick, false);
    attach(headerNavItems[i], device(), navigationClick);
  }

  for (var i = 0; i < footerNavItems.length; i++){
   //footerNavItems[i].addEventListener(device(), navigationClick, false);
   attach(footerNavItems[i], device(), navigationClick);
  }

  var click = document.getElementById('js-get-in-touch');

  if (click){
    //click.addEventListener(device(), navigationClick, false);
    attach(click, device(), navigationClick);
  }

  if (window.location.pathname.match(/portfolio/) || window.location.pathname === '/')
    portfolioClickEvents();

  /** Next Previous */
  var homeNext = function (e) {
    clearInterval(homeTimer);
    removeClass(html, 'boom');
    setTimeout(function () {
      updateProgress(25, pageLoader);
      loadAnotherHomePage(current, 'next');
    }, 700);
    e.preventDefault();
  };

  var homePrevious = function (e) {
    clearInterval(homeTimer);
    removeClass(html, 'boom');
    setTimeout(function () {
      updateProgress(25, pageLoader);
      loadAnotherHomePage(current, 'previous');
    }, 700);
    e.preventDefault();
  };

  swipe();

  if (window.addEventListener) {
    window.addEventListener('keyup', function (e) {
      if (window.location.pathname === '/') {
        if (e.keyCode === 38 || e.keyCode === 40){
          var link = document.getElementById('js-project-link');
          routing(link.getAttribute('href'));
        }
        if (e.keyCode === 39){
          clearInterval(homeTimer);
          removeClass(html, 'boom');
          setTimeout(function () {
            updateProgress(25, pageLoader);
            loadAnotherHomePage(current, 'next');
          }, 700); 
        }
        if (e.keyCode === 37){
          clearInterval(homeTimer);
          removeClass(html, 'boom');
          setTimeout(function () {
            updateProgress(25, pageLoader);
            loadAnotherHomePage(current, 'previous');
          }, 700);
        }
        e.preventDefault();
      }
    }, false);
  }
  
  /** Page load */
  homeClickEvents();

  Fluidvids.init({ selector: 'iframe', players: ['www.youtube.com', 'player.vimeo.com'] });

  setTimeout(function () {

    // if (window.location.pathname === '/') {
    //   loadHomepage();
    // } else {
      addClass(html, 'boom');
    // }

  }, 100);

  if (window.addEventListener) {
    adapt_to_orientation();
    window.addEventListener('orientationchange', function() {
      adapt_to_orientation();
    }, false);
  }

  var head = document.querySelectorAll('.portfolio-item__header')[0];

  if (head && window.location.pathname != '/contact') {
    head.innerHTML += '<a class="arrow-down" href="#jump" id="jump"></a>';
    arrowClickEvent();
  }

  // if (window.location.pathname === '/')
  //   homePlay();

  if (window.location.pathname === '/portfolio' 
    || window.location.pathname === '/about' 
    || window.location.pathname === '/index.html' 
    || window.location.pathname === '/' 
    || window.location.pathname === '/about/') {
    var imgTags = document.querySelectorAll('.portfolio-list li img');
    for (var i = 0; i < imgTags.length; i++) {
      loadImageAndDisplay(imgTags[i],i*80);
    }
  }

  if (window.location.pathname.match(/portfolio/) 
    || window.location.pathname === '/about' 
    || window.location.pathname === '/' 
    || window.location.pathname === '/about/') {
    var count = 0, amnt = 0, total = 0;
    imgTags = contentBlock.querySelectorAll('img');
    count = imgTags.length;
    amnt = Math.ceil(100/count);
    for (var i = 0; i < imgTags.length; i++) {
      total+=amnt;
      updateProgress(total, pageLoader);
      loadImageAndDisplaySection(imgTags[i], i*80, total);
    }
  }

  /*if (window.location.pathname === '/contact') {
    //var contactContent = document.getElementById('js-contact');
    var contactOverlay = document.getElementById('js-contact-overlay');
    contactOverlay.setAttribute('data-state', contactOverlay.getAttribute('data-state') === 'visible' ? 'hidden' : 'visible');
    //contactOverlay.innerHTML = '<div class="contact">' + contactContent.innerHTML  + '</div>';
    //addClass(pageHeader,'white');
  }*/

  //changeMikeImage();

  if (window.addEventListener) {
    window.addEventListener('popstate', function (e) {
      var initialPop = !pushStatePopped && location.href == initialURL;
      pushStatePopped = true;
      if (initialPop) return;
      if (location.pathname === '/') window.location.href = '/';
      routing(location.pathname);
    }, false);

    // window.addEventListener('scroll', function (e) {
    //   var viewMore = document.getElementById('view-more');
    //   if (viewMore && window.location.pathname != '/portfolio' && window.location.pathname.match(/portfolio/)) {
    //     var scrollHeight = document.documentElement.clientHeight;
    //     var scrollPos = window.pageYOffset ? window.pageYOffset + window.innerHeight : document.documentElement.scrollTop + window.innerHeight;
    //     if (scrollPos > (scrollHeight-500) && !portfolioFooterLoaded) {
    //       portfolioFooterLoaded = true;
    //       loadFooterPortfolio(viewMore);
    //     }
    //   }
    // }, false);
  }

  /** Page functions */
  function swipe () {

    var touchsurface = document.getElementById('js-content-block')
    , startX
    , startY
    , dist
    , threshold = 150
    , allowedTime = 200
    , elapsedTime
    , startTime;

    function handleswipe (isrightswipe) {

      clearInterval(homeTimer);

      if (isrightswipe){
        removeClass(html, 'boom');
        setTimeout(function () {
          updateProgress(25, pageLoader);
          loadAnotherHomePage(current, 'next');
        }, 700);
      } else {
        removeClass(html, 'boom');
        setTimeout(function () {
          updateProgress(25, pageLoader);
          loadAnotherHomePage(current, 'previous');
        }, 700);
      }
    }

    if (window.addEventListener) {
      touchsurface.addEventListener('touchstart', function (e) {
        if (window.location.pathname === '/') {
          var touchobj = e.changedTouches[0];
          dist = 0;
          startX = touchobj.pageX;
          startY = touchobj.pageY;
          startTime = new Date().getTime();
        }
      }, false);

      touchsurface.addEventListener('touchmove', function (e) {
         if (window.location.pathname === '/') {
          e.preventDefault();
         }
      }, false);

      touchsurface.addEventListener('touchend', function (e) {
        if (window.location.pathname === '/') {
          var touchobj = e.changedTouches[0];
          dist = touchobj.pageX - startX;
          elapsedTime = new Date().getTime() - startTime;
          var swiperightBol = (elapsedTime <= allowedTime && dist >= threshold && Math.abs(touchobj.pageY - startY) <= 100);
          if (dist > 100 || dist < -100)
            handleswipe(swiperightBol);
          e.preventDefault();
        }
      }, false);
    }

  }

  function portfolioClickEvents () {
    var portfolioItems = document.querySelectorAll('.portfolio-list li a');
    for (var i = 0; i < portfolioItems.length; i++){
      attach(portfolioItems[i], desktop(), navigationClick);
      //portfolioItems[i].addEventListener(desktop(), navigationClick, false);
    }
  }

  function homeClickEvents () {
    var projectLink = document.getElementById('js-project-link');

    if (projectLink){
      //projectLink.addEventListener(device(), navigationClick, false);
      attach(projectLink, device(), navigationClick);
    }

    var nLink = document.getElementById('js-next');
    var pLink = document.getElementById('js-previous');

    if (nLink){
      attach(nLink, device(), homeNext);
      //nLink.addEventListener(device(), homeNext, false);
    }

    if (pLink){
      attach(pLink, device(), homePrevious);
      //pLink.addEventListener(device(), homePrevious, false);
    }
  }

  function routing (href) {

    portfolioFooterLoaded = true;

    clearInterval(homeTimer);

    contentBlock.setAttribute('class', 'container');
    contentBlock.innerHTML = '';
    
    var portfolio = document.querySelectorAll('.portfolio-list')[0];

    if (portfolio)
      portfolio.parentNode.removeChild(portfolio);

    var viewMore = document.getElementById('view-more');
    viewMore.style.display = 'none';
    viewMore.style.opacity = 0;;

    var menuNav = headerNav.querySelectorAll('li');

    if (hasClass(pageHeader, 'white')) {
      removeClass(pageHeader,'white');
      removeClass(projectNav,'white');
    }

    whiteMenu = false;

    pageLoader.style.display = 'block';
    pageLoader.style.width = '10%';

    removeClassRegex(html, /\url-\S+/g);
    addClass(html, 'url-' + slugify(href));

    for (var i = 0; i < menuNav.length; i++) {
      removeClass(menuNav[i], 'sel');
      var thisHref = menuNav[i].getElementsByTagName('a')[0].getAttribute('href');
      //if (thisHref.match(href.split('/')[1]))
      if (thisHref === '/' && (window.location.pathname === '/' || window.location.pathname.indexOf('/portfolio/') !== -1))
        addClass(menuNav[i], 'sel');
      if (thisHref === '/about' && (window.location.pathname === '/about' && window.location.pathname === '/about/'))
        addClass(menuNav[i], 'sel');
    }

    // if (ga) {
    //   ga('send', 'pageview', {
    //     'page': href
    //   });
    // }

    //return;

    if (href === '/' || href === '/index.html')
      loadPortfolio(href);
    else if (href.match(/portfolio/))
      loadPortfolioItem(href);
    else
      loadPage(href);
  }

  // function loadHomepage () {

  //   var xhr = new XMLHttpRequest();
  //   xhr.open('GET', '/_collections?collection=portfolio&home=true&order=desc')
  //   xhr.onreadystatechange = function (e) {
  //     if (xhr.readyState === 4) {
  //       if (xhr.status === 200) {
  //         var data = JSON.parse(xhr.responseText);
  //         for(var i in data.collection) {
  //           var obj = { 
  //             homestyle: data.collection[i].homestyle,
  //             homeimage: data.collection[i].homeimage,
  //             slug: data.collection[i].slug,
  //             whitenav: data.collection[i].whitenav
  //           };
  //           homepageData.push(obj);
  //         }
  //         if (data.collection.length === 1) {
  //           addClass(html, 'boom');
  //         } else {
  //           var ind = Math.floor(Math.random()*data.collection.length);
  //           loadAnotherHomePage(ind, 'next');
  //         }
  //       } else {
  //         // No error
  //       }
  //     }
  //   }
  //   xhr.send();  

  // }

  function arrowClickEvent () {
    var arrowClick = function (e) {
      var offset = this.parentNode.nextSibling.nextSibling.getBoundingClientRect().top;
      var n = (offset + scrollTo().scrollTop);

      if (document.documentElement.scrollTop)
        scrollTo().scrollTop = n;
      else
        window.scrollBy(0, n);

      e.preventDefault();      
    };
    var arrowBtn = document.querySelectorAll('.arrow-down')[0];
    //arrowBtn.addEventListener(device(), arrowClick, false);
    attach(arrowBtn, device(), arrowClick);
  }

  function jumpTop () {
    document.body.scrollTop = 0;
  }

  function scrollTo () {
    return document.documentElement || document.body;
  }

  function homePlay () {
    clearInterval(homeTimer);
    homeTimer = setInterval(function () { 
      removeClass(html, 'boom');
      setTimeout(function () {
        updateProgress(25, pageLoader);
        loadAnotherHomePage(current, 'next');
      }, 700); 
    }, 12000);
  }

  function loadAnotherHomePage (i, which) {

    clearInterval(progressTimer);

    i = (which === 'previous') ? i = i-1 : i = i+1;
    i = i > homepageData.length-1 ? 0 : i;
    i = i < 0 ? homepageData.length-1 : i;
    var imageAlreadySeen = false;

    current = i;

    contentBlock.setAttribute('class', 'container ' + homepageData[i].homestyle);

    var imgTags = contentBlock.querySelectorAll('img');

    for (var a = 0; a < imgTags.length; a++) {
      imgTags[a].style.display = 'none';
    }

    var id = document.getElementById(homepageData[i].homestyle);

    if (id) {
      imageAlreadySeen = true;
    } else {
      var img = new Image();
      img.src = amazonLink + homepageData[i].homeimage;
      img.id = homepageData[i].homestyle;
      img.className = 'js-img';
      img.alt = 'homepage project image';
      contentBlock.appendChild(img);
    }

    id = document.getElementById(homepageData[i].homestyle);

    var pLink = document.getElementById('js-project-link');
    var next = document.getElementById('js-next')
    var prev = document.getElementById('js-previous')

    next.setAttribute('data-index', i);
    prev.setAttribute('data-index', i);
    pLink.setAttribute('href', homepageData[i].slug);
    
    if (homepageData[i].whitenav) {
      addClass(pageHeader,'white');
      addClass(projectNav,'white');
      whiteMenu = true;
    } else {
      removeClass(pageHeader,'white');
      removeClass(projectNav,'white');
      whiteMenu = false;
    }

    var up = 50;
    progressTimer = setInterval(function () { 
      up=up+5;
      updateProgress(up, pageLoader); 
    }, 1000);

    if (!imageAlreadySeen) {
      var img = new Image();
      img.onload = function () {
        addClass(html, 'boom');
        clearInterval(progressTimer);
        updateProgress(100, pageLoader); 
        id.style.display = 'inline-block';
        id.style.opacity = 1;
      };
      img.src = id.getAttribute('src');
    } else {
      addClass(html, 'boom');
      clearInterval(progressTimer);
      updateProgress(100, pageLoader); 
      id.style.display = 'inline-block';
      id.style.opacity = 1;
    }

    homeClickEvents();

  }

  function loadFooterPortfolio (el) {

    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/partials/portfolio.html')
    xhr.onreadystatechange = function (e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          el.style.display = 'block';
          el.style.opacity = 1;
          var div = document.createElement('div');
          div.innerHTML = xhr.responseText;
          el.parentNode.insertBefore(div.childNodes[1], document.getElementsByTagName('footer')[0]);
          var imgTags = document.querySelectorAll('.portfolio-list li a img');
          for (var i = 0; i < imgTags.length; i++) {
            loadImageAndDisplay(imgTags[i],i*80);
          }
          portfolioClickEvents();
        } else {
          window.location.href = href;
        }
      }
    }
    xhr.send();

  }

  function loadPortfolio (href) {

    var xhr = new XMLHttpRequest();
    xhr.addEventListener('progress', function (e) { progressLoader(e, pageLoader); }, false);
    xhr.open('GET', '/partials/portfolio.html')
    xhr.onreadystatechange = function (e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          document.title = 'Mike Kus • ' + document.querySelectorAll('.page-foot__strap')[0].innerHTML;
          updateProgress(100, pageLoader);
          contentBlock.innerHTML = xhr.responseText;
          var imgTags = contentBlock.querySelectorAll('img');
          for (var i = 0; i < imgTags.length; i++) {
            loadImageAndDisplay(imgTags[i],i*80);
          }
          portfolioClickEvents();
          jumpTop();
        } else {
          window.location.href = href;
        }
      }
    }
    xhr.send();

  }

  function loadPortfolioItem (href) {

    //console.log(1, href)

    var count = 0, amnt = 0, total = 75;
    var url = '/collections/' + href.replace('/portfolio/','') + '.json';

    //console.log(url)

    var xhr = new XMLHttpRequest();
    xhr.addEventListener('progress', function (e) { progressLoader(e, pageLoader); }, false);
    xhr.open('GET', url);
    xhr.onreadystatechange = function (e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          updateProgress(75, pageLoader);
          var data = JSON.parse(xhr.responseText);
          //console.log(data)
          contentBlock.innerHTML = data.collection[0].body;
          count = contentBlock.querySelectorAll('img').length;
          amnt = Math.ceil(25/count);
          document.title = 'Portfolio: ' + data.collection[0].title + ' : Mike Kus • ' + document.querySelectorAll('.page-foot__strap')[0].innerHTML;
          var imgTags = contentBlock.querySelectorAll('img');
          var imgs = [];
          var loadedImgs = 0;
          for (var i = 0; i < imgTags.length; i++) {
            imgs[i] = new Image()
            imgs[i].onload = function () {
              loadedImgs++;
              total+=amnt;
              updateProgress(total, pageLoader);
              if (loadedImgs === imgTags.length-1) {
                jumpTop();
                updateProgress(100, pageLoader);
                document.querySelectorAll('.portfolio-item__header')[0].innerHTML += '<a class="arrow-down" href="#jump" id="jump"></a>';
                arrowClickEvent();
                var sections = contentBlock.querySelectorAll('section');
                for (var i = 0; i < sections.length; i++) {
                  sections[i].style.opacity = 1;
                }
              }
            };
            imgs[i].src = imgTags[i].getAttribute('src');
          }
          portfolioFooterLoaded = false;
          Fluidvids.init({ selector: 'iframe', players: ['www.youtube.com', 'player.vimeo.com'] });
        } else {
          window.location.href = href;
        }
      }
    }
    xhr.send();

  }

  function loadPage (href) {

//console.log('/partials' + href + '.html')

    var xhr = new XMLHttpRequest();
    xhr.addEventListener('progress', function (e) { progressLoader(e, pageLoader); }, false);
    xhr.open('GET', '/partials' + href + '.html')
    xhr.onreadystatechange = function (e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          document.title = 'Mike Kus • ' + document.querySelectorAll('.page-foot__strap')[0].innerHTML;
          updateProgress(100, pageLoader);
          //console.log(xhr.responseText)
          contentBlock.innerHTML = xhr.responseText;
          jumpTop();
          if (href === '/about' || href === '/about/') {
            document.querySelectorAll('.portfolio-item__header')[0].innerHTML += '<a class="arrow-down" href="#jump" id="jump"></a>';
            arrowClickEvent();
          }
          if (href === '/about' || href === '/about/') {
            var click = document.getElementById('js-get-in-touch');
            if (click)
              click.addEventListener(device(), navigationClick, false);
            var count = 0, amnt = 0, total = 0;
            imgTags = contentBlock.querySelectorAll('img');
            count = imgTags.length;
            amnt = Math.ceil(100/count);
            for (var i = 0; i < imgTags.length; i++) {
              total+=amnt;
              updateProgress(total, pageLoader);
              loadImageAndDisplaySection(imgTags[i], i*80, total);
            }
            var portfolioTags = document.querySelectorAll('.portfolio-list li img');
            for (var i = 0; i < portfolioTags.length; i++) {
              loadImageAndDisplay(portfolioTags[i],i*80);
            }
            //changeMikeImage();
          }

        } else {
          window.location.href = href;
        }
      }
    }
    xhr.send();

  }

  /** Generic functions */

  function adapt_to_orientation () {

    var maxwidth = getStyle(document.getElementsByTagName('html')[0], 'max-width').replace('px','');
    var meta = document.querySelectorAll('meta[name=viewport]')[0];

    if (maxwidth != 'none') {
      meta.setAttribute('content', 'width=' + maxwidth + ',initial-scale=1');
    } else {
      meta.setAttribute('content', 'width=device-width,initial-scale=1');
    }
    
  }

  function getStyle (el, styleProp) {
    var value, defaultView = (el.ownerDocument || document).defaultView;
    if (defaultView && defaultView.getComputedStyle) {
      styleProp = styleProp.replace(/([A-Z])/g, "-$1").toLowerCase();
      return defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
    } else if (el.currentStyle) {
      styleProp = styleProp.replace(/\-(\w)/g, function(str, letter) {
        return letter.toUpperCase();
      });
      value = el.currentStyle[styleProp];
      if (/^\d+(em|pt|%|ex)?$/i.test(value)) { 
        return (function(value) {
          var oldLeft = el.style.left, oldRsLeft = el.runtimeStyle.left;
          el.runtimeStyle.left = el.currentStyle.left;
          el.style.left = value || 0;
          value = el.style.pixelLeft + "px";
          el.style.left = oldLeft;
          el.runtimeStyle.left = oldRsLeft;
          return value;
        })(value);
      }
      return value;
    }
  }

  function insertAfter (referenceNode, newNode) {
    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
  }

  function loadImageAndDisplaySection (el, time, total) {
    var img = new Image();
    img.onload = function () {
      if (total) {
        var sections = contentBlock.querySelectorAll('section');
        for (var i = 0; i < sections.length; i++) {
          sections[i].style.opacity = 1;
        }
      }
    };
    img.src = el.getAttribute('src');
  }

  function loadImageAndDisplay (el, time) {
    var img = new Image();
    img.onload = function () {
      setTimeout(function () { el.style.opacity = 1; }, time);
    };
    img.src = el.getAttribute('src');
  }

  function progressLoader (e, el) {
    if (e.lengthComputable)
      el.style.width = (e.loaded / e.total) * 100 + '%';
    else
      updateProgress(50, el);
  }

  function updateProgress (n, el) {
    el.style.width = n + '%';

    if (n >= 100)
      setTimeout(function() { el.style.display = 'none'; }, 350);
  }

  function pushHistory (href) {
    if ('pushState' in history)
      history.pushState(null, null, href);
    else
      window.location.href = href;
  }

  function hasClass (el, className) {
    return new RegExp(' ' + className + ' ').test(' ' + el.className + ' ');
  }

  function addClass (el, className) {
    if (el && !hasClass(el, className)) {
      el.className += ' ' + className;
    }
  }

  function removeClass (el, className) {
    var newClass = ' ' + el.className.replace(/[\t\r\n]/g, ' ') + ' ';
    if (hasClass(el, className)) {
      while (newClass.indexOf(' ' + className + ' ') >= 0 ) {
        newClass = newClass.replace(' ' + className + ' ', ' ');
      }
      el.className = newClass.replace(/^\s+|\s+$/g, '');
    }
  }

  function removeClassRegex (el, regex) {
    var newClass = el.className.match(regex);
    removeClass(el, newClass);
  }

  function slugify (text) {
    return text
      .toLowerCase()
      .replace(/[^\w ]+/g,'')
      .replace(/ +/g,'-');
  }

  function attach (obj, event, fn) {
    if (window.addEventListener) {
      obj.addEventListener(event, fn, false);
    } else {
      obj.attachEvent('on' + event, fn);
    }
  }

})(window, document);